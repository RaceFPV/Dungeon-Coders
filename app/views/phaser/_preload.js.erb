//this function will handle client communication with the server
var clientSetup = function() {
		//create() is moved here to make sure nothing is created before uniq id assignation
		Menu();
}

var goleft = function(i) {
    playersList[i].dude.body.x -= 4;
    playersList[i].dude.animations.play('left');
  }
var goright = function(i) {
    playersList[i].dude.body.x += 4;
    playersList[i].dude.animations.play('right');
  }
var goup = function(i) {
    playersList[i].dude.body.y -= 4;
    playersList[i].dude.animations.play('up');
  }
var godown = function(i) {
    playersList[i].dude.body.y += 4;
    playersList[i].dude.animations.play('down');
  }
var attack = function(i) {
  //check for npc dialog
  if (playernpclocation(level1npc, playersList[i].dude)) {
    playersList[i].dialog.x = playersList[i].dude.body.x-50;
    playersList[i].dialog.y = playersList[i].dude.body.y+10;
    playersList[i].dialog.alpha = 1;
    playersList[i].dialog.setText('"Begin your journey into the ruby mine."');
    game.time.events.add(5000, function() {
      game.add.tween(playersList[i].dialog).to({alpha: 0}, 2500, Phaser.Easing.Linear.None, true);
    }, this);
    playersList[i].dude.animations.stop();
  }
  else if (playernpclocation(level2npc, playersList[i].dude)) {
    playersList[i].dialog.x = playersList[i].dude.body.x-50;
    playersList[i].dialog.y = playersList[i].dude.body.y+10;
    playersList[i].dialog.alpha = 1;
    playersList[i].dialog.setText('"There are too many pythons down there now, come back later."');
    game.time.events.add(5000, function() {
      game.add.tween(playersList[i].dialog).to({alpha: 0}, 2500, Phaser.Easing.Linear.None, true);
    }, this);
    playersList[i].dude.animations.stop();
  }
  else if (playernpclocation(level3npc, playersList[i].dude)) {
    playersList[i].dialog.x = playersList[i].dude.body.x-50;
    playersList[i].dialog.y = playersList[i].dude.body.y+10;
    playersList[i].dialog.alpha = 1;
    playersList[i].dialog.setText('"We are still digging out these java mines, come back later."');
    game.time.events.add(5000, function() {
      game.add.tween(playersList[i].dialog).to({alpha: 0}, 2500, Phaser.Easing.Linear.None, true);
    }, this);
    playersList[i].dude.animations.stop();
  }
  else if (playernpclocation(level4npc, playersList[i].dude)) {
    playersList[i].dialog.x = playersList[i].dude.body.x-50;
    playersList[i].dialog.y = playersList[i].dude.body.y+10;
    playersList[i].dialog.alpha = 1;
    playersList[i].dialog.setText('"The door seems shut by some sort of java with scripture, come back later."');
    game.time.events.add(5000, function() {
      game.add.tween(playersList[i].dialog).to({alpha: 0}, 2500, Phaser.Easing.Linear.None, true);
    }, this);
    playersList[i].dude.animations.stop();
  }
  else if (playernpclocation(level5npc, playersList[i].dude)) {
    playersList[i].dialog.x = playersList[i].dude.body.x-50;
    playersList[i].dialog.y = playersList[i].dude.body.y+10;
    playersList[i].dialog.alpha = 1;
    playersList[i].dialog.setText('"Its too dark to see sharply yet, come back later."');
    game.time.events.add(5000, function() {
      game.add.tween(playersList[i].dialog).to({alpha: 0}, 2500, Phaser.Easing.Linear.None, true);
    }, this);
    playersList[i].dude.animations.stop();
  }
  else if (playernpclocation(level1dialog, playersList[i].dude)) {
    playersList[i].dialog.x = playersList[i].dude.body.x-50;
    playersList[i].dialog.y = playersList[i].dude.body.y+10;
    playersList[i].dialog.alpha = 1;
    playersList[i].dialog.setText('"Once upon a time, there were numbers and letters. \n To assign a number or letter you would use something called a variable. \n The left tunnel uses x = 5 as a number variable \n while the right tunnel uses var number == 5 \n choosing the right variable may be helpful in the future."');
    game.time.events.add(10000, function() {
      game.add.tween(playersList[i].dialog).to({alpha: 0}, 2500, Phaser.Easing.Linear.None, true);
    }, this);
    playersList[i].dude.animations.stop();
  }
  //end npc dialog check
  else {
    playersList[i].dude.animations.stop();
  }
}

var killMe = function(i) {
        console.log('KILL');
	      playersList[i].alive = false;
	      playersList[i].kill();
}

//teleporter location check
var teleportplayer1 = function(i) {
  return Phaser.Rectangle.contains(level1teleport, i.body.x, i.body.y);
}

teleportplayer1home = function(i) {
  return Phaser.Rectangle.contains(hometeleport1, i.body.x, i.body.y);
}

teleportplayer1success = function(i) {
  return Phaser.Rectangle.contains(level1teleportsuccess, i.body.x, i.body.y);
}

teleportplayer1fail = function(i) {
  return Phaser.Rectangle.contains(level1teleportfail, i.body.x, i.body.y);
}

//npc location check
var playernpclocation = function(x, i) {
  return Phaser.Rectangle.contains(x, i.body.x, i.body.y);
}
//end npc location check


var width = $('#gamescreen').innerWidth() - 50;
var height = $('#gamescreen').innerHeight();
var game = new Phaser.Game(width, height, Phaser.AUTO, 'gamescreen', { preload: preload, loadUpdate: loadUpdate, create: clientSetup, update: update, render: render });

function preload() {

  this.preloadBar = game.add.graphics(0, 50);
  this.preloadBar.lineStyle(3, 0xffffff, 1);
  this.preloadBar.moveTo(0, 0);
  this.preloadBar.lineTo(game.width+100, 0);
  this.preloadBar.scale.x = 0; // set the bar to the beginning position

    game.load.tilemap('level',"assets/tileset/levelbeforecrash.json",null, Phaser.Tilemap.TILED_JSON);
    game.load.image('tiles1',"assets/tileset/hyptosis_tile-art-batch-1.png");
    game.load.image('tiles2',"assets/tileset/hyptosis_tile-art-batch-2.png");
    game.load.spritesheet('dude',"assets/tileset/playersprite.png",100,146);
    game.load.bitmapFont('carrier_command', 'assets/fonts/carrier_command.png', 'assets/fonts/carrier_command.xml');
    game.load.audio('theme1','assets/audio/RPG-Theme_v001.mp3');
}

function loadUpdate() {
  // every frame during loading, set the scale.x of the bar to the progress (an integer between 0
  // and 100) divided by 100 to give a float between 0 and 1
  this.preloadBar.scale.x = game.load.progress * 0.01;
}